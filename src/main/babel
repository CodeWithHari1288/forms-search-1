import React, { useState } from "react";
import { CopilotKit, useCopilotAction } from "@copilotkit/react-core";

// runtimeUrl is required by the provider, but we won't actually use it.
// The custom action handler bypasses it by doing fetch() directly.
const UNUSED_RUNTIME_URL = "http://localhost:0/unused";

function DemoForm() {
  const [query, setQuery] = useState("hello from copilot action");
  const [flag, setFlag] = useState(true);
  const [result, setResult] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);

  // Define the custom action with the hook
const sendToPython = useCopilotAction({
    name: "sendToPython",
    description: "Send custom body to FastAPI",
    parameters: [
      { name: "query", type: "string", description: "User query" },
      { name: "flag", type: "boolean", description: "Extra flag" },
    ],
    handler: async ({ query, flag }) => {
      const resp = await fetch("http://localhost:8000/myapi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, flag, ts: new Date().toISOString() }),
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`Python API error: ${resp.status} ${txt}`);
      }

      return resp.json();
    },
  });


  return (
    <div style={{ display: "grid", gap: 12 }}>
      <label>
        Query:
        <input
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          style={{ marginLeft: 8, width: "100%" }}
        />
      </label>
      <label>
        Flag:
        <input
          type="checkbox"
          checked={flag}
          onChange={(e) => setFlag(e.target.checked)}
          style={{ marginLeft: 8 }}
        />
      </label>
     <button
  onClick={async () => {
    setError(null);
    setResult(null);
    try {
      const resp = await fetch("http://localhost:8000/myapi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, flag }),
      });
      const out = await resp.json();
      setResult(out);
    } catch (err: any) {
      setError(err.message);
    }
  }}
>
  Send directly
</button>

      {error && (
        <pre style={{ color: "crimson", whiteSpace: "pre-wrap" }}>{error}</pre>
      )}
      {result && (
        <pre
          style={{
            background: "#f7f7f7",
            padding: 12,
            borderRadius: 8,
          }}
        >
          {JSON.stringify(result, null, 2)}
        </pre>
      )}
    </div>
  );
}

export default function App() {
  return (
    <CopilotKit runtimeUrl={UNUSED_RUNTIME_URL}>
      <div style={{ fontFamily: "Inter, system-ui, Arial", padding: 24 }}>
        <h1>CopilotKit useCopilotAction â†’ Python API</h1>
        <p>
          This demo uses the <code>useCopilotAction</code> hook to define a
          custom action that calls a FastAPI endpoint at{" "}
          <code>http://localhost:8000/myapi</code>.
        </p>
        <DemoForm />
      </div>
    </CopilotKit>
  );
}
